> **Note**: For detailed architecture documentation, see [AGENTS.md](AGENTS.md)

# Repository Guidelines

## Project Structure & Module Organization

This Next.js 15 App Router project keeps page segments in `src/app`; place client UI and route handlers here. Shared backend helpers and the Prisma client wrapper live in `src/server`. Global styles are collected in `src/styles/globals.css`, while static assets belong in `public`. Database schema and migrations stay in `prisma`, with generated client code ignored from version control. Run `start-database.sh` to boot the local database service before Prisma workflows.

## Build, Test, and Development Commands

- `bun install` — install dependencies as tracked in `bun.lock`.
- `bun run dev` — start the HMR dev server on the default port.
- `bun run build` — create the production bundle and run type checks.
- `bun run preview` — serve the built app for smoke testing.
- `bun run check` — run ESLint and TypeScript without touching output.
- `bun run db:generate` / `bun run db:migrate` — regenerate the Prisma client and apply schema migrations.
- `bun run roadmap:build` — regenerate `graph.json` from markdown frontmatter (see Auto-Layout System below).

## Coding Style & Naming Conventions

Prettier (`prettier.config.js`) handles formatting; run `bun run format:write` or rely on editor integration. ESLint (`eslint.config.js`) plus TypeScript enforce modern React rules. Stick to 2-space indentation, PascalCase for React components, camelCase for variables/functions, and kebab-case for segment folders inside `src/app`. Keep server-only utilities in `src/server` or `prisma` to prevent accidental client bundling.

## Testing Guidelines

Use Vitest for all tests (65+ existing tests). Run `bun run test` for watch mode, `bun run test:run` for single run, or `bun run test:ui` for interactive UI. **Important**: Do NOT use `bun test` - it runs Bun's native test runner which is incompatible with these tests.

Tests mirror source structure with `__tests__/` folders (e.g., `src/lib/__tests__/utils.test.ts`). Use `vi.mock()` for module-level mocking (Prisma, Redis, fetch) and `vi.fn()` for function mocking. Test files disable strict ESLint type-checking rules that conflict with Vitest patterns. Coverage includes roadmap-loader, embeddings-client, system status, utils, chat API, and type definitions.

## Commit & Pull Request Guidelines

Write imperative, present-tense commit subjects under 72 characters (e.g., `Add profile form validation`). Squash noisy formatting updates into the related commit. Every PR should link issues, summarize the change, list verification commands, and attach UI captures for user-facing work. Request review for updates touching Prisma schema or server logic.

## Database & Configuration Tips

Environment variables are validated in `src/env.js` via `@t3-oss/env-nextjs`; extend that module whenever adding new `.env` keys. After editing `prisma/schema.prisma`, rerun `bun run db:generate` and restart the dev server. Do not commit secrets or local database artifacts; store credentials in the shared secret manager.

The `PRODUCTION` env var controls whether to use local Docker services (Postgres/Redis) or production services (Neon/Upstash). Set `PRODUCTION=true` for deployments.

## Security & Performance

- **Rate Limiting**: Chat API uses Redis-backed sliding window (10 req/min) via `@upstash/ratelimit`
- **Input Validation**: Zod schemas validate all API inputs (max 50 messages, 10k chars each)
- **Timeouts**: Embeddings API calls have 30s timeout with AbortController
- **Caching**: Roadmap data cached in-memory with 5-minute TTL via `roadmapCache`
- **Error Boundaries**: Client-side error boundary wraps complex React Flow components
- **Health Checks**: System status page monitors Database, Redis, Clerk, and Embeddings API

⚠️ Chat API has no authentication yet (MVP-acceptable) - add Clerk protection before public launch.

## Dynamic Roadmap System

- **Architecture**: Content-driven system with separation of concerns (content/layout/metadata)
- **Data Structure**: Roadmap data lives in `src/data/roadmaps/{roadmap-id}/` with three files:
  - `metadata.json`: Career-level info (title, province, industry)
  - `graph.json`: React Flow layout (node positions, edges, connections) — **auto-generated, do not edit manually**
  - `content/*.md`: Markdown files with YAML frontmatter for each node (includes layout config)
- **Auto-Layout System**: Layout data lives in markdown frontmatter; `bun run roadmap:build` generates `graph.json`
  - Main nodes declare `layout.position` and `layout.connectsTo` in frontmatter
  - Subnodes (checklists) declare `layout.milestoneId` and `layout.labelPosition`
  - Builder script validates all connections and auto-calculates subnode positions
  - **Workflow**: Edit markdown → run `bun run roadmap:build` → commit generated `graph.json`
  - See `docs/ROADMAP_AUTO_LAYOUT.md` for complete guide
- **Data Loading**: Server-side loading via `src/lib/roadmap-loader.ts`
- **Node Types**: `hub` (yellow, main path nodes), `terminal` (purple, final goal), `checklist` (teal subnodes) — fully implemented. Types `requirement`, `portal`, `checkpoint` are aliased to `hub` but not used in current roadmap.
- **Adding Content**: Create markdown file in `content/` with layout config, run `bun run roadmap:build` - no manual graph editing needed
- **Documentation**: See `docs/ROADMAP_SYSTEM.md` and `docs/ROADMAP_AUTO_LAYOUT.md`
